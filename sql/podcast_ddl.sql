-- vim: set ts=4 expandtab
SET client_min_messages TO WARNING;
SET ROLE=pod_admin;

-- DROP SCHEMA IF EXISTS podcast CASCADE CASCADE;
-- CREATE SCHEMA podcast;

SET search_path TO podcast;


/**
 *
 *  Extensions, Functions, and Stored Procedures
 *
 **/
--
-- Function to automate updated of `date_modified` columns so that the application is not responsible for managing that value.
--
CREATE OR REPLACE FUNCTION update_date_modified_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.date_modified = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';


DROP TABLE IF EXISTS struct_type CASCADE;
CREATE TABLE struct_type (
      struct_type_id                                                            INTEGER                                     NOT NULL GENERATED BY DEFAULT AS IDENTITY
    , date_created                                                              TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , date_modified                                                             TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , display_order                                                             SMALLINT                                    NOT NULL
    , group_name                                                                TEXT                                        NOT NULL
    , att_pub_ident                                                             TEXT                                        NOT NULL
    , att_value                                                                 TEXT                                        NOT NULL
    , PRIMARY KEY (struct_type_id)
);
CREATE UNIQUE INDEX idx_stuct_type_att_pub_ident                                ON struct_type                              USING btree (group_name, att_pub_ident);


DROP TABLE IF EXISTS ingest CASCADE;
CREATE TABLE ingest (
      ingest_id                                                                 INTEGER                                     NOT NULL GENERATED BY DEFAULT AS IDENTITY
    , file_hash                                                                 TEXT                                        NOT NULL           -- hash of the entire file read as a string
    , podcast_uuid                                                              UUID                                        NOT NULL
    , PRIMARY KEY (ingest_id)
);
CREATE UNIQUE INDEX idx_ingest_podcast_uuid                                     ON ingest                                   USING btree (podcast_uuid);


DROP TABLE IF EXISTS meta_container CASCADE;
CREATE TABLE meta_container (
      meta_container_id                                                         INTEGER                                     NOT NULL GENERATED BY DEFAULT AS IDENTITY
    , container_name                                                            TEXT                                        NOT NULL           -- hash of the entire file read as a string
    , PRIMARY KEY (meta_container_id)
);


DROP TABLE IF EXISTS container_podcast_lnk CASCADE;
CREATE TABLE container_podcast_lnk (
      meta_container_id                                                         INTEGER                                     NOT NULL GENERATED BY DEFAULT AS IDENTITY
    , podcast_id                                                                TEXT                                        NOT NULL           -- hash of the entire file read as a string
    , PRIMARY KEY (meta_container_id, podcast_id)
);


DROP TABLE IF EXISTS purgatory CASCADE;
CREATE TABLE purgatory (
      purgatory_id                                                              INTEGER                                     NOT NULL
    , podcast_uuid                                                              UUID                                                   -- to OS
    , date_created                                                              TIMESTAMPTZ                                          DEFAULT CURRENT_TIMESTAMP
    , date_modified                                                             TIMESTAMPTZ                                          DEFAULT CURRENT_TIMESTAMP
    , description_selected                                                      INTEGER                                                         -- 110=Cleaned, 120=ChatGPT
    , readability                                                               INTEGER                                              DEFAULT 0
    , is_explicit                                                               BOOLEAN                                                         -- 0=False 1=True
    , index_status                                                              INTEGER                                              DEFAULT 310        CHECK(index_status IN (310, 320, 330)) -- 1=AUTO 2=MANUAL 3=EXCLUDED
    , episode_count                                                             INTEGER
    , is_deleted                                                                BOOLEAN                                              DEFAULT FALSE
    , advanced_popularity                                                       FLOAT                                                DEFAULT 0   -- used for calculating APS
    , reason_for_failure                                                        TEXT                                        NOT NULL
    , file_name                                                                 TEXT
    , file_hash                                                                 TEXT                                        NOT NULL           -- hash of the entire file read as a string
    , title_cleaned                                                             TEXT                                           -- to OS
    , author                                                                    TEXT                                           -- to OS
    , language                                                                  VARCHAR(4)                                             -- to OS
    , description_cleaned                                                       TEXT
    , image_url                                                                 TEXT                                           -- to OS
    , rss_url                                                                   TEXT                                          -- to OS
) PARTITION BY HASH (purgatory_id);
CREATE INDEX idx_purgatory_purgatory_id                                         ON purgatory                                USING btree (purgatory_id);
CREATE TABLE purgatory_00 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 0);
CREATE TABLE purgatory_01 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 1);
CREATE TABLE purgatory_02 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 2);
CREATE TABLE purgatory_03 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 3);
CREATE TABLE purgatory_04 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 4);
CREATE TABLE purgatory_05 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 5);
CREATE TABLE purgatory_06 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 6);
CREATE TABLE purgatory_07 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 7);
CREATE TABLE purgatory_08 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 8);
CREATE TABLE purgatory_09 PARTITION OF purgatory FOR VALUES WITH (MODULUS 10, REMAINDER 9);


DROP TABLE IF EXISTS error_log CASCADE;
CREATE TABLE error_log (
      file_name                                                                 TEXT                               			NOT NULL
    , error                                                                     TEXT                                        NOT NULL
    , stack_trace                                                               TEXT                                        NOT NULL
    , date_created                                                              TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
);


DROP TABLE IF EXISTS active CASCADE;
CREATE TABLE active (
      active_id                                                                 INTEGER                                     NOT NULL GENERATED BY DEFAULT AS IDENTITY
    , podcast_uuid                                                              UUID                                        NOT NULL        -- to OS
    , date_created                                                              TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , date_modified                                                             TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , description_selected                                                      INTEGER                                     NOT NULL        -- 110=Cleaned, 120=ChatGPT
    , readability                                                               INTEGER                                     NOT NULL DEFAULT 0
    , is_explicit                                                               BOOLEAN                                     NOT NULL
    , index_status                                                              INTEGER                                     NOT NULL DEFAULT 310   CHECK(index_status IN (310, 320, 330)) -- 1=AUTO 2=MANUAL 3=EXCLUDED
    , episode_count                                                             INTEGER                                     NOT NULL
    , is_deleted                                                                BOOLEAN                                     NOT NULL DEFAULT FALSE
    , advanced_popularity                                                       FLOAT                                       NOT NULL DEFAULT 0   -- used for calculating APS
    , file_name                                                                 TEXT                                 		NOT NULL
    , file_hash                                                                 TEXT                                        NOT NULL           -- hash of the entire file read as a string
    , title_cleaned                                                             TEXT                                		NOT NULL        -- to OS
    , title_lemma                                                               TEXT                                		NOT NULL        -- to OS
    , author                                                                    TEXT                                                		-- to OS
    , language                                                                  VARCHAR(4)                                  NOT NULL        -- to OS
    , description_cleaned                                                       TEXT                                        NOT NULL
    , description_chatgpt                                                       TEXT
    , description_lemma                                                         TEXT                                        NOT NULL        -- to OS
    , vector                                                                    BYTEA                                       NOT NULL        -- to OS
    , image_url                                                                 TEXT                                                		-- to OS
    , rss_url                                                                   TEXT                                		NOT NULL        -- to OS
--    , PRIMARY KEY (active_id)
) PARTITION BY HASH (active_id);
CREATE INDEX idx_active_active_id                                               ON active                                   USING btree (active_id);
CREATE TABLE active_00 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 0);
CREATE TABLE active_01 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 1);
CREATE TABLE active_02 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 2);
CREATE TABLE active_03 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 3);
CREATE TABLE active_04 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 4);
CREATE TABLE active_05 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 5);
CREATE TABLE active_06 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 6);
CREATE TABLE active_07 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 7);
CREATE TABLE active_08 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 8);
CREATE TABLE active_09 PARTITION OF active FOR VALUES WITH (MODULUS 10, REMAINDER 9);



DROP TABLE IF EXISTS quarantine CASCADE;
CREATE TABLE quarantine (
      quarantine_id                                                             INTEGER                                     NOT NULL GENERATED BY DEFAULT AS IDENTITY
    , date_processed                                                            TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , podcast_uuid                                                              UUID                                        NOT NULL
    , original_podcast_uuid                                                     UUID                                        NOT NULL
    , duplicate_file_name                                                       TEXT                                		NOT NULL
    , PRIMARY KEY (quarantine_id)
);
CREATE UNIQUE INDEX idx_quarantine_podcast_uuid       							ON quarantine    							USING btree (podcast_uuid);


DROP TABLE IF EXISTS station CASCADE;
CREATE TABLE station (
      station_uuid                                                              UUID                                       NOT NULL
    , station_name                                                              TEXT                                       NOT NULL
    , call_sign                                                                 TEXT                                       NOT NULL
    , station_id                                                                INTEGER                                    NOT NULL
    , category_id                                                               SMALLINT
    , format_id                                                                 SMALLINT
    , organization_id                                                           SMALLINT
    , band_id                                                                   SMALLINT
    , geo_position                                                              POINT
    , date_acquired                                                             DATE
    , date_disposed                                                             DATE
    , has_jump2go                                                               BOOLEAN
    , is_searchable                                                             BOOLEAN
    , frequency                                                                 TEXT
    , website                                                                   TEXT
    , slug                                                                      TEXT
    , phonetic_name                                                             TEXT
    , slogan                                                                    TEXT
    , description                                                               TEXT
    , date_created                                                              TIMESTAMPTZ
    , date_modified                                                             TIMESTAMPTZ
    , site_slug                                                                 TEXT
    , seo_description                                                           TEXT
    , status                                                                    BOOLEAN
    , is_explicit                                                               BOOLEAN
    , publish_state_id                                                          INTEGER
    , PRIMARY KEY (station_uuid)
);

DROP TABLE IF EXISTS station CASCADE;
CREATE TABLE station (
      station_uuid                                                              UUID                                       NOT NULL
    , date_created                                                              TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , date_modified                                                             TIMESTAMPTZ                                 NOT NULL DEFAULT CURRENT_TIMESTAMP
    , description_selected                                                      INTEGER                                     NOT NULL        -- 110=Cleaned, 120=ChatGPT
    , is_explicit                                                               BOOLEAN                                     NOT NULL
    , index_status                                                              INTEGER                                     NOT NULL DEFAULT 310   CHECK(index_status IN (310, 320, 330)) -- 1=AUTO 2=MANUAL 3=EXCLUDED
    , is_deleted                                                                BOOLEAN                                     NOT NULL DEFAULT FALSE
    , advanced_popularity                                                       FLOAT                                       NOT NULL DEFAULT 0   -- used for calculating APS
    , title_cleaned                                                             TEXT                                		NOT NULL        -- to OS
    , title_lemma                                                               TEXT                                		NOT NULL        -- to OS
    , language                                                                  VARCHAR(4)                                  NOT NULL        -- to OS
    , description_cleaned                                                       TEXT                                        NOT NULL
    , description_chatgpt                                                       TEXT
    , description_lemma                                                         TEXT                                        NOT NULL        -- to OS
    , vector                                                                    BYTEA                                       NOT NULL        -- to OS
    , image_url                                                                 TEXT                                                		-- to OS                                                        INTEGER
    , PRIMARY KEY (station_uuid)
);
